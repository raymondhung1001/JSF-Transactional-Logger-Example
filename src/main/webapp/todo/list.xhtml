<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    <h:head>
        <title>My Todos</title>
        <h:outputStylesheet library="webjars" name="bootstrap/4.6.2/css/bootstrap.min.css"/>
        <h:outputScript name="js/session-timeout.js" target="head"/>
        <style>
            body {
                background-color: #f5f5f5;
            }
            .navbar {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .navbar-brand, .navbar-text {
                color: white !important;
            }
            .todo-container {
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                padding: 2rem;
                margin-top: 2rem;
            }
            .todo-completed {
                opacity: 0.6;
                text-decoration: line-through;
            }
        </style>
    </h:head>
    <h:body>
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="pi pi-check-square"></i> Todo App
                </a>
                <div class="navbar-nav ml-auto">
                    <span class="navbar-text mr-3">
                        Welcome, #{loginBean.currentUser.fullName} (#{loginBean.currentUser.username})
                    </span>
                    <h:form>
                        <p:commandButton id="logoutBtn" value="Logout" 
                                       action="#{loginBean.logout}" 
                                       styleClass="btn btn-outline-light"
                                       icon="pi pi-sign-out"
                                       ajax="false"/>
                    </h:form>
                </div>
            </div>
        </nav>
        
        <div class="container">
            <p:messages id="messages" showDetail="true" closable="true"/>
            
            <!-- Single Form containing everything -->
            <div class="todo-container">
                <h:form id="mainTodoForm">
                    
                    <!-- Header with Add Button -->
                    <h:panelGroup id="todoHeader">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>
                                <i class="pi pi-list"></i> My Todos 
                                <span class="badge badge-primary">#{todoBean.todos != null ? todoBean.todos.size() : 0}</span>
                            </h3>
                            <p:commandButton value="Add New Todo" 
                                           action="#{todoBean.prepareAddTodo}"
                                           styleClass="btn btn-primary"
                                           icon="pi pi-plus"
                                           update=":mainTodoForm:todoDialog"
                                           process="@this"
                                           oncomplete="PF('todoDialog').show();"/>
                        </div>
                    </h:panelGroup>
                    
                    <!-- DataTable for todos -->
                    <h:panelGroup id="todoTableWrapper">
                        <p:dataTable id="todoTable" 
                                   value="#{todoBean.todos}" 
                                   var="todo"
                                   emptyMessage="No todos yet. Click 'Add New Todo' to get started!"
                                   styleClass="table table-hover"
                                   rowStyleClass="#{todo.completed ? 'todo-completed' : ''}"
                                   rows="10"
                                   paginator="#{todoBean.todos.size() gt 10}"
                                   paginatorPosition="bottom">
                            
                            <p:column headerText="Title" style="width: 20%;">
                                <h:outputText value="#{todo.title}"/>
                            </p:column>
                            
                            <p:column headerText="Description" style="width: 30%;">
                                <h:outputText value="#{todo.description}" rendered="#{not empty todo.description}"/>
                                <h:outputText value="-" styleClass="text-muted" rendered="#{empty todo.description}"/>
                            </p:column>
                            
                            <p:column headerText="Created Date" style="width: 15%;">
                                <h:outputText value="#{todo.createdDate}">
                                    <f:convertDateTime pattern="yyyy-MM-dd HH:mm"/>
                                </h:outputText>
                            </p:column>
                            
                            <p:column headerText="Completed Date" style="width: 15%;">
                                <h:outputText value="#{todo.completedDate}" rendered="#{todo.completed and todo.completedDate != null}">
                                    <f:convertDateTime pattern="yyyy-MM-dd HH:mm"/>
                                </h:outputText>
                                <h:outputText value="-" styleClass="text-muted" rendered="#{not todo.completed or todo.completedDate == null}"/>
                            </p:column>
                            
                            <p:column headerText="Status" style="width: 10%;">
                                <h:outputText value="Completed" styleClass="badge badge-success" rendered="#{todo.completed}"/>
                                <h:outputText value="Pending" styleClass="badge badge-warning" rendered="#{not todo.completed}"/>
                            </p:column>
                            
                            <p:column headerText="Actions" style="width: 10%;">
                                <p:commandButton icon="pi pi-pencil" 
                                               styleClass="btn btn-sm btn-warning mr-1"
                                               action="#{todoBean.selectTodo(todo)}"
                                               update=":mainTodoForm:todoDialog"
                                               process="@this"
                                               oncomplete="PF('todoDialog').show();"
                                               title="Edit"/>
                                <p:commandButton icon="pi pi-trash" 
                                               styleClass="btn btn-sm btn-danger"
                                               action="#{todoBean.deleteTodo(todo.id)}"
                                               update=":mainTodoForm:todoTableWrapper :mainTodoForm:todoHeader :messages"
                                               process="@this"
                                               title="Delete">
                                    <p:confirm header="Confirmation" message="Are you sure you want to delete this todo?" 
                                              icon="pi pi-exclamation-triangle"/>
                                </p:commandButton>
                            </p:column>
                        </p:dataTable>
                    </h:panelGroup>
                    
                    <!-- Todo Dialog for Add/Edit -->
                    <p:dialog id="todoDialog" 
                             header="#{todoBean.editMode ? 'Edit Todo' : 'Add New Todo'}" 
                             widgetVar="todoDialog" 
                             modal="true" 
                             resizable="false" 
                             width="500"
                             height="auto">
                        
                        <h:panelGroup id="dialogContent">
                            <div class="form-group">
                                <h:outputLabel for="dialogTitle" value="Title" styleClass="form-label"/>
                                <p:inputText id="dialogTitle" 
                                           value="#{todoBean.title}" 
                                           styleClass="form-control" 
                                           placeholder="Enter todo title"
                                           required="true"
                                           requiredMessage="Title is required"/>
                            </div>
                            <div class="form-group">
                                <h:outputLabel for="dialogDescription" value="Description" styleClass="form-label"/>
                                <p:inputTextarea id="dialogDescription" 
                                               value="#{todoBean.description}" 
                                               styleClass="form-control" 
                                               placeholder="Enter todo description"
                                               rows="3"/>
                            </div>
                        </h:panelGroup>
                        
                        <f:facet name="footer">
                            <p:commandButton value="#{todoBean.editMode ? 'Update' : 'Add'}" 
                                           action="#{todoBean.saveTodo}" 
                                           styleClass="btn btn-primary"
                                           icon="#{todoBean.editMode ? 'pi pi-check' : 'pi pi-plus'}"
                                           update=":mainTodoForm:todoTableWrapper :mainTodoForm:todoHeader :messages :mainTodoForm:dialogContent"
                                           oncomplete="if(!args.validationFailed) { PF('todoDialog').hide(); }"/>
                            <p:commandButton value="Cancel" 
                                           styleClass="btn btn-secondary"
                                           icon="pi pi-times"
                                           onclick="PF('todoDialog').hide(); return false;"/>
                        </f:facet>
                    </p:dialog>
                    
                    <!-- Confirmation Dialog -->
                    <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
                        <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes btn btn-danger" icon="pi pi-check"/>
                        <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no btn btn-secondary" icon="pi pi-times"/>
                    </p:confirmDialog>
                    
                </h:form>
            </div>
        </div>
        
        <!-- Session Timeout Warning Dialog -->
        <p:dialog header="Session Timeout Warning" widgetVar="sessionTimeoutDialog" modal="true" 
                  resizable="false" closable="false" draggable="false" style="width: 450px">
            <div class="text-center">
                <i class="pi pi-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i>
                <h4 style="color: #dc3545; margin-bottom: 1rem;">Your session is about to expire</h4>
                <p>Your session will expire due to inactivity in <strong id="sessionCountdown">5:00</strong> minutes.</p>
                <p class="text-muted">Click "Stay Logged In" to continue your session.</p>
            </div>
            <f:facet name="footer">
                <p:commandButton value="Stay Logged In" 
                               action="#{loginBean.keepSessionAlive}"
                               styleClass="btn btn-primary"
                               icon="pi pi-check"
                               oncomplete="if(window.sessionTimeoutManager) { window.sessionTimeoutManager.updateActivity(); } PF('sessionTimeoutDialog').hide();"/>
                <p:commandButton value="Logout Now" 
                               action="#{loginBean.logout}"
                               styleClass="btn btn-secondary"
                               icon="pi pi-sign-out"
                               ajax="false"/>
            </f:facet>
        </p:dialog>
        
        <!-- Session Keep-Alive Poll -->
        <h:form id="pollForm" style="display: none;">
            <p:poll interval="60" listener="#{loginBean.keepSessionAlive}" 
                    update="@none"/>
        </h:form>
        
        <!-- Hidden logout button for back button detection -->
        <h:form id="backButtonLogoutForm" style="display: none;">
            <p:commandButton id="backButtonLogoutBtn" 
                           action="#{loginBean.logoutAjax}" 
                           update="@none"
                           style="display: none;"/>
        </h:form>
        
        <h:outputScript library="webjars" name="bootstrap/4.6.2/js/bootstrap.bundle.min.js"/>
        <h:outputScript>
            // Expose functions for session timeout manager
            window.keepSessionAlive = function() {
                // This will be called by the session timeout manager
                // The PrimeFaces poll component handles the actual keep-alive
            };
            
            window.logoutAction = function() {
                // Trigger logout via PrimeFaces remote command
                if (typeof PrimeFaces !== 'undefined') {
                    PrimeFaces.ab({source: 'logoutBtn', event: 'click'});
                }
            };
            
            // Back button detection - this will be handled by session-timeout.js
            // but we ensure it's initialized here as well
            if (window.sessionTimeoutManager &amp;&amp; typeof window.sessionTimeoutManager.logoutOnBackButton === 'function') {
                // Already initialized by session-timeout.js
            } else {
                // Fallback initialization if session-timeout.js hasn't loaded yet
                window.addEventListener('pageshow', function(event) {
                    if (event.persisted) {
                        // Page loaded from cache (back button)
                        const basePath = window.location.pathname.replace(/\/todo\/.*/, '');
                        window.location.href = basePath + '/login.xhtml?backButton=true';
                    }
                });
            }
        </h:outputScript>
    </h:body>
</html>